<link href="/static/css/style.default.css" rel="stylesheet">
<link href="/static/css/select2.css" rel="stylesheet">

<div class="pageheader">
    <h2><i class="fa fa-table"></i> 模版列表 </h2>
</div>

<div class="contentpanel">
    <div class="panel panel-default">

        <div class="panel-body">
            <h3 class="panel-title">查询</h3>
            <form class="form-horizontal form-bordered" action="" method="get">
                <div class="form-group">
                    <label class="col-sm-3 control-label">标题: <span class="asterisk"></span></label>
                    <div class="col-sm-5">
                        <input type="text" name="class_key" class="form-control" value="{{.query.class_key}}" placeholder="请填写标题..."/>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-sm-5 col-sm-offset-3">
                        <button class="btn btn-primary">提交</button>
                    </div>
                </div>
            </form>

        </div>

        <div class="panel-footer">
            <div class="table-responsive">
                <table class="table table-striped table-layout" id="dataTable">
                    <thead>
                    <tr>
                        <th>照片URL</th>
                        <th>标题</th>
                        <th>内容</th>
                        <th>价格</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>

                    <tbody id="maintablebody">
                    </tbody>


                        <div class="dataTables_length">
                            <label>每页</label>
                            <label>
                                <select id="stepInput" name="perPageNums" onChange="currentPatchPage = 1;changeStep(false)">
                                    <option value="10" selected="selected">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </label>
                            <label>行</label>
                        </div>
                        <div id="pageLabelDiv" class="dataTables_paginate paging_bootstrap pagination">
                            <ul class="pagination pagination-sm">
                            </ul>
                        </div>
                        <div class="form-group">
                            <div class="col-md-10"></div>
                            <div class="col-md-2" align="right"><button data-toggle="modal" href="#myModal" class="btn btn-success  btn-sm" onclick="currentId = 0;clearForm();">新增</button></div>
                        </div>


                </table>
            </div><!-- table-responsive -->




            <!--	//-----------弹出创建的窗口------start------------>
            <div class="modal fade" id="myModal" tabindex="-100" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h4 class="modal-title" id="addAPIUserTitle">添加基础信息</h4>
                        </div>

                        <div class="modal-body row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>所属平台</label>
                                    <select id="basicSystem" name="basicSystem" class="form-control">
                                        <option value="0">iphone</option>
                                        <option value="1">android</option>
                                        <option value="2">ipad</option>
                                        <option value="3">android pad</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-body row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>类型</label>
                                    <select id="basicType" name="basicType" class="form-control">
                                        <option value="appver">版本号</option>
                                        <option value="bundleId">包名</option>
                                        <option value="system">系统</option>
                                        <option value="osversion">系统版本号</option>
                                        <option value="brand">手机厂商名</option>
                                        <option value="model">手机型号</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-body row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label>类型值</label>
                                    <input type="text" class="form-control" id="basicValue" />
                                </div>
                            </div>
                        </div>

                        <div class="modal-body row">
                            <div class="col-md-5">

                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-success  btn-sm" onclick="saveNewitem()">保存</button>
                            </div>
                            <div class="col-md-5">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--   //-----------弹出创建的窗口------end----------      -->


        </div><!-- panel-body -->
    </div><!-- panel -->

</div><!-- contentpanel -->

<script src="/static/js/jquery-1.11.1.min.js"></script>
<script src="/static/js/select2.min.js"></script>

<script>
    //每页的条数发生改变时  重新计算分页条数
    function changeStep(onlyChangeStep) {
        var pagelabelDiv = $("#pageLabelDiv ul");
        pagelabelDiv.empty();
        var stepinput = document.getElementById("stepInput")
        step = parseInt(stepinput.options[stepinput.selectedIndex].value);
        var pageNum = Math.ceil(totalCount / step);
        if (currentPage <= 1) {
            pagelabelDiv.append('<li class="disabled"><a href="#">上一页</a></li>')
        } else {
            pagelabelDiv.append('<li class="" onclick="getList(' + (currentPage - 1) + ',' + step + ')" ><a href="#">上一页</a></li>')
        }
        if (pageNum > 6) {
            for (var i = 1; i <= pageNum; i++) {
                if ((i) == currentPage) {
                    pagelabelDiv.append('<li class="active"><a>' + (i) + '</a></li>')
                } else if ((i <= 2)) {
                    pagelabelDiv.append('<li onclick="getList(' + i + ',' + step + ')"><a  href="#">' + (i) + '</a></li>')
                } else if ((i >= currentPage - 1 && (i <= currentPage + 1)) || (i > pageNum - 2)) {
                    pagelabelDiv.append('<li onclick="getList(' + i + ',' + step + ')"><a  href="#">' + (i) + '</a></li>')
                }
            }

        } else {
            for (var i = 1; i <= pageNum; i++) {
                if ((i) == currentPage) {
                    pagelabelDiv.append('<li class="active"><a>' + (i) + '</a></li>')
                } else {
                    pagelabelDiv.append('<li onclick="getList(' + i + ',' + step + ')"><a  href="#">' + (i) + '</a></li>')
                }
            }
        }
        if (currentPage >= pageNum) {
            pagelabelDiv.append('<li class="disabled"><a href="#">下一页</a></li>')
        } else {
            pagelabelDiv.append('<li class="" onclick="getList(' + (currentPage + 1) + ',' + step + ')" ><a href="#">下一页</a></li>')
        }
        if (onlyChangeStep == false) {
            getList(currentPage, step);
        }
    }
    jQuery(document).ready(function() {
        // Select2
        jQuery("#stepInput").select2({
            width: '100%',
            minimumResultsForSearch: -1
        });
    });


    var totalCount = 0
    var currentPage = 1
    var step = 10
    var tablebody
    var currentListData
    var adddata
    var host

    //页面载入后先获取默认条数的数据
    window.onload = function () {
        host = "http://" + window.location.host
        getList(currentPage, step);
    };

    //从API获取数据列表
    function getList(page, tempstep) {
        currentPage = page;
        step = tempstep
        searchList();
    }

    //----------------------------上面为相同部分---------------------------------------------


    //点击提交按钮
    function searchList() {
        $.get(host + "/Stencil/show/" + currentPage + "/step/" + step, null, listToSuccess, "json");
    }

    //从数据库中获取列表成功
    function listToSuccess(response, status, xhr) {
        if (status == "success" && response.reusltCode == "200") {
            currentListData = response.reusltDetail.dataList;
            totalCount = response.totalCount;
            clearDataTable();
            changeStep(true);
            fillTable();
            parent.setMainContentHeight(currentListData.length, 52);
        } else {
            alert(response);
        }

    }

    //清空数据表格
    function clearDataTable() {
        tablebody = $("#maintablebody");
        tablebody.empty();
    }

    //采用本地数组中的数据填充表格
    function fillTable() {
        adddata = "";
        $.each(currentListData, function (index, item) {
            adddata += ("<tr name=" + index + ">");
            adddata += ("<td class=\"\">" + item.image + "</td>");
            adddata += ("<td class=\"\">" + item.title + "</td>");
            adddata += ("<td class=\"\">" + item.content + "</td>");
            adddata += ("<td class=\"\">" + item.price + "</td>");
            adddata += ("<td class=\"\">" + item.time + "</td>");
            adddata += ("<td class=\"table-action table-operate\"> " +
                "<a data-toggle='modal' href='#myModal'   onclick='editItem(" + index + ")' ><i class=\"fa fa-pencil\"></i></a> " +
                "<a data-toggle='modal' href='#setApiUserModal'  onclick='deleteItem(" + item.id  + ")' ><i class=\"fa fa-trash-o\"></i></a>" +
                "</td>");
            adddata += "</tr>";

        });
        tablebody.append(adddata);
    }


    //点击编辑按钮的时候
    function saveNewitem() {

        var cType = document.getElementById("basicType").value;
        currentType = cType;
        var currentdata = new Object();
        currentdata.id = currentId;
        currentdata.system = document.getElementById("basicSystem").value;
        currentdata.type = cType;
        currentdata.value = document.getElementById("basicValue").value;
        if (currentdata.system == "") {
            document.getElementById("basicValue").focus();
            alert("所属平台必须填写");
            return;
        }else {
            currentdata.system = parseInt(document.getElementById("basicSystem").value,10)
        }

        if (currentdata.type == "") {
            document.getElementById("basicType").focus();
            alert("类型必须填写");
            return;
        }
        if (currentdata.value == "") {
            document.getElementById("basicValue").focus();
            alert("类型的值必须填写");
            return;
        }

        currentdata.page = currentPage;
        currentdata.step = step;
        $.ajaxSetup({
            contentType: 'application/json'
        });
        $.post(host + "/add_basic_info", JSON.stringify(currentdata), returnSuccess, "json");

    }
    //保存成功
    function returnSuccess(response, status, xhr) {
        if(status == "success" && response.reusltCode == "200") {
            getList(currentPage, step, currentType);
            currentId = 0;
            currentListData = response.reusltDetail;
            $('#myModal').modal('hide');
            alert("操作成功！");
        } else {
            alert(response);
        }
    }


    //点击编辑按钮的时候
    function editItem(i) {
        currentTabIndex = i;
        currentId = currentListData[i].id;
        $("#basicSystem").val(currentListData[i].system);
        $("#basicType").val(currentListData[i].type);
//        document.getElementById("basicType").value = currentListData[i].type;
        document.getElementById("basicValue").value = currentListData[i].value;
    }


</script>